<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Materia≈Çy kursu | Centrum Szkoleniowe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Lista modu≈Ç√≥w i materia≈Ç√≥w kursu: zacznij naukƒô, ≈õled≈∫ postƒôpy i przejd≈∫ do quizu." />
  <link rel="stylesheet" href="style.css" />
  <style>
    .mods{display:grid;gap:14px}
    @media(min-width:900px){.mods{grid-template-columns:1fr 1fr}}
    .mod{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:16px;display:grid;gap:8px;box-shadow:0 6px 18px rgba(16,22,38,.04)}
    .mod h3{margin:0}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:700}
    .bar{height:8px;border:1px solid var(--border);border-radius:999px;background:#fff;overflow:hidden}
    .bar>i{display:block;height:100%;width:0;background:linear-gradient(135deg,var(--violet),var(--pink));transition:width .35s ease}
    .lead{color:var(--muted);margin:0}
  </style>
</head>
<body>
  <header class="header">
    <div class="container header__inner">
      <div class="brand"><span class="brand__dot"></span><span>Centrum Szkoleniowe</span></div>
      <button id="menu" class="hamburger" aria-label="Menu" title="Menu">‚â°</button>
      <nav id="nav" class="nav">
        <a class="nav-link" href="./index.html#sklep">Sklep</a>
        <a class="nav-link" href="./index.html#faq">FAQ</a>
        <a class="nav-link" href="./panel.html">Panel</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="banner reveal center">
      <h1 id="title">Materia≈Çy kursu üìö</h1>
      <p id="desc" class="muted">Wczytywanie opisu‚Ä¶</p>
      <div class="banner__cta">
        <a class="btn btn--ghost" href="./index.html#sklep">‚Üê Wr√≥ƒá do sklepu</a>
        <a id="quizBtn" class="btn" href="#">Przejd≈∫ do quizu</a>
      </div>
    </section>

    <!-- MODU≈ÅY -->
    <section class="container section reveal" aria-label="Modu≈Çy">
      <div class="section__head">
        <div>
          <h2 class="section__title">Twoje modu≈Çy</h2>
          <p class="section__desc">Otw√≥rz modu≈Ç, przerabiaj lekcje i ≈õled≈∫ postƒôpy</p>
        </div>
      </div>

      <div id="mods" class="mods" data-stagger>
        <!-- wype≈Çniane JS -->
      </div>
      <p id="state" class="section__desc" style="margin-top:10px"></p>
    </section>
  </main>

  <footer class="container section" style="padding-bottom:28px">
    <hr/>
    <div style="display:flex;gap:12px;justify-content:space-between;flex-wrap:wrap">
      <div>&copy; <span id="year"></span> Centrum Szkoleniowe</div>
      <nav style="display:flex;gap:10px">
        <a class="nav-link" href="./polityka.html">Polityka prywatno≈õci</a>
        <a class="nav-link" href="./regulamin.html">Regulamin</a>
      </nav>
    </div>
  </footer>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    /* ===== helpers/api ===== */
    const qs=(s,el=document)=>el.querySelector(s);
    const qsa=(s,el=document)=>Array.from(el.querySelectorAll(s));
    const toast=(m)=>{const el=qs('#toast'); el.textContent=m; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2600);};
    const handle=async(r)=>{let j=null; try{j=await r.json();}catch{} if(!r.ok||(j&&j.ok===false)){throw new Error(j?.error?.message||`HTTP ${r.status}`)} return j??{ok:true,data:null}};
    const api={get:(u)=>fetch(u,{credentials:'same-origin'}).then(handle)};

    /* nav/year/reveal */
    const nav=qs('#nav'); qs('#menu')?.addEventListener('click',()=>nav?.classList.toggle('open'));
    qs('#year').textContent=new Date().getFullYear();
    const io=new IntersectionObserver(ents=>{ents.forEach(e=>{if(e.isIntersecting){e.target.classList.add('in'); io.unobserve(e.target)}})},{threshold:.15});
    qsa('.reveal').forEach(el=>io.observe(el));
    const setStagger=(root=document)=>root.querySelectorAll('[data-stagger]').forEach(box=>Array.from(box.children).forEach((ch,i)=>ch.style.setProperty('--d',`${Math.min(i*80,400)}ms`)));
    setStagger();

    /* params */
    const p=new URLSearchParams(location.search);
    const slug=p.get('slug') || localStorage.getItem('lastCourseSlug') || '';
    if(!slug){ toast('Brak identyfikatora kursu (?slug=)'); }

    const title=qs('#title'); const desc=qs('#desc'); const modsBox=qs('#mods'); const state=qs('#state'); const quizBtn=qs('#quizBtn');

    function localProgressKey(){ return `progress_${slug}`; }
    function readProgress(){
      try{ return JSON.parse(localStorage.getItem(localProgressKey())||'{}'); }catch{ return {}; }
    }
    function setBar(bar,done,total){
      const pct = total? Math.round(done/total*100):0;
      bar.style.setProperty('width', pct+'%');
    }

    async function loadMeta(){
      try{
        const { data } = await api.get(`/api/catalog/${slug}`);
        title.textContent = `Materia≈Çy: ${data.title} üìö`;
        desc.textContent  = data.description || 'Modu≈Çy i lekcje kursu.';
        quizBtn.href = `./quiz.html?slug=${encodeURIComponent(slug)}`;
      }catch{}
    }

    async function loadModules(){
      state.textContent='Wczytujƒô modu≈Çy‚Ä¶';
      const endpoints = [
        `/api/courses/${slug}/materials`,
        `/api/catalog/${slug}/materials`,
        `/api/materials?slug=${encodeURIComponent(slug)}`,
        `/api/materials/${encodeURIComponent(slug)}`
      ];
      let payload=null;
      for(const url of endpoints){
        try{ const j = await api.get(url); payload = j.data; if(payload) break; }catch{}
      }
      const items = Array.isArray(payload?.modules) ? payload.modules
                  : Array.isArray(payload?.items) ? payload.items
                  : Array.isArray(payload) ? payload : [];
      if(!items.length){ state.textContent='Brak modu≈Ç√≥w do wy≈õwietlenia.'; return; }
      state.textContent='';
      const prog = readProgress(); // { [moduleId]: {done, total} }
      modsBox.innerHTML = items.map((m,i)=>{
        const id = m.id ?? m.moduleId ?? `m${i}`;
        const lessons = m.lessons || m.items || [];
        const total = lessons.length;
        const done  = prog[id]?.done ?? 0;
        const pct   = total? Math.round(done/total*100) : 0;
        return `
          <article class="mod reveal">
            <h3>${m.title || m.name || 'Modu≈Ç'}</h3>
            <p class="lead">${m.description || m.desc || 'Zawarto≈õƒá modu≈Çu.'}</p>
            <div class="meta">
              <span class="chip">Lekcje: ${total}</span>
              <span class="chip">Postƒôp: ${pct}%</span>
            </div>
            <div class="bar" aria-hidden="true"><i style="width:${pct}%"></i></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <a class="btn" href="./module.html?course=${encodeURIComponent(slug)}&module=${encodeURIComponent(id)}">Otw√≥rz modu≈Ç</a>
              <a class="btn btn--ghost" href="./quiz.html?slug=${encodeURIComponent(slug)}">Przejd≈∫ do quizu</a>
            </div>
          </article>
        `;
      }).join('');
      setStagger(document);
      qsa('.reveal', modsBox).forEach(el=>io.observe(el));
    }

    await loadMeta();
    await loadModules();
  </script>
</body>
</html>
