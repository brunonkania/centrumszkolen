<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Panel użytkownika | Centrum Szkoleniowe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Dostęp do kursów, zamówień i certyfikatów. Kontynuuj naukę i weryfikuj dokumenty." />
  <link rel="stylesheet" href="style.css" />
  <style>
    .cards{display:grid;gap:14px}
    @media(min-width:980px){.cards{grid-template-columns:repeat(3,1fr)}}
    .kcard{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 6px 18px rgba(16,22,38,.04);display:grid;gap:8px}
    .muted-small{color:var(--muted);font-size:13px}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{font-size:13px;color:var(--muted);text-align:left;padding:0 10px}
    .row{background:#fff;border:1px solid var(--border);border-radius:12px}
    .row td{padding:10px}
  </style>
</head>
<body>
  <header class="header">
    <div class="container header__inner">
      <div class="brand"><span class="brand__dot"></span><span>Centrum Szkoleniowe</span></div>
      <button id="menu" class="hamburger" aria-label="Menu" title="Menu">≡</button>
      <nav id="nav" class="nav">
        <a class="nav-link" href="./index.html#sklep">Sklep</a>
        <a class="nav-link" href="./index.html#faq">FAQ</a>
        <a id="logout" class="nav-link" href="#">Wyloguj</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="banner reveal center">
      <h1 id="hello">Twój panel 👋</h1>
      <p id="sub" class="muted">Zobacz zakupione kursy, wróć do materiałów i sprawdź certyfikaty.</p>
      <div class="banner__cta">
        <a class="btn" href="./index.html#sklep">Kup kolejny kurs</a>
        <a class="btn btn--ghost" href="./verify.html">Zweryfikuj certyfikat</a>
      </div>
    </section>

    <!-- Kafle szybkiego dostępu -->
    <section class="container section reveal">
      <div class="cards" data-stagger id="quick">
        <article class="kcard reveal">
          <h3>📚 Moje kursy</h3>
          <p class="muted">Lista aktywnych dostępów i linki do materiałów.</p>
          <div><a class="btn" href="#courses">Przejdź ↘</a></div>
        </article>
        <article class="kcard reveal">
          <h3>🧠 Ostatni quiz</h3>
          <p class="muted">Wznów ostatni egzamin lub sprawdź wynik.</p>
          <div><a id="resumeQuiz" class="btn btn--ghost" href="#">Wznów</a></div>
        </article>
        <article class="kcard reveal">
          <h3>🏆 Certyfikaty</h3>
          <p class="muted">Weryfikacja certyfikatów online.</p>
          <div><a class="btn btn--ghost" href="./verify-certyfikat.html">Weryfikuj</a></div>
        </article>
      </div>
    </section>

    <!-- Kursy (zamówienia) -->
    <section id="courses" class="container section reveal">
      <div class="section__head">
        <div>
          <h2 class="section__title">Zakupione kursy</h2>
          <p class="section__desc">Kliknij „Materiały” aby kontynuować naukę</p>
        </div>
      </div>
      <div id="state" class="section__desc">Ładuję…</div>
      <table class="table" style="margin-top:10px">
        <thead><tr><th>Kurs</th><th>Data</th><th>Status</th><th></th></tr></thead>
        <tbody id="orders">
          <!-- wypełnia JS -->
        </tbody>
      </table>
    </section>
  </main>

  <footer class="container section" style="padding-bottom:28px">
    <hr/>
    <div style="display:flex;gap:12px;justify-content:space-between;flex-wrap:wrap">
      <div>&copy; <span id="year"></span> Centrum Szkoleniowe</div>
      <nav style="display:flex;gap:10px">
        <a class="nav-link" href="./polityka.html">Polityka prywatności</a>
        <a class="nav-link" href="./regulamin.html">Regulamin</a>
      </nav>
    </div>
  </footer>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    /* helpers */
    const qs=(s,el=document)=>el.querySelector(s);
    const qsa=(s,el=document)=>Array.from(el.querySelectorAll(s));
    const toast=(m)=>{const el=qs('#toast'); el.textContent=m; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2600);};
    const handle=async(r)=>{let j=null; try{j=await r.json();}catch{} if(!r.ok||(j&&j.ok===false)){throw new Error(j?.error?.message||`HTTP ${r.status}`)} return j??{ok:true,data:null}};
    const api={get:(u)=>fetch(u,{credentials:'same-origin'}).then(handle), post:(u,b)=>fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'same-origin',body:JSON.stringify(b||{})}).then(handle)};

    /* nav/year/reveal */
    const nav=qs('#nav'); qs('#menu')?.addEventListener('click',()=>nav?.classList.toggle('open'));
    qs('#year').textContent=new Date().getFullYear();
    const io=new IntersectionObserver(ents=>{ents.forEach(e=>{if(e.isIntersecting){e.target.classList.add('in'); io.unobserve(e.target)}})},{threshold:.15});
    qsa('.reveal').forEach(el=>io.observe(el));
    const setStagger=(root=document)=>root.querySelectorAll('[data-stagger]').forEach(b=>Array.from(b.children).forEach((c,i)=>c.style.setProperty('--d',`${Math.min(i*80,400)}ms`)));
    setStagger();

    /* load me + orders */
    async function loadMe(){
      try{
        const m = await api.get('/api/me');
        if(m?.data?.email){ qs('#hello').textContent = `Cześć, ${m.data.email} 👋`; }
      }catch{}
      // Resume quiz link z localStorage
      const slug = localStorage.getItem('lastCourseSlug');
      qs('#resumeQuiz').href = slug ? `./quiz.html?slug=${encodeURIComponent(slug)}` : './quiz.html';
    }

    function moneyPLN(cents=0){ return new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format((cents||0)/100); }
    function fmtDate(s){ try{ return new Date(s).toLocaleDateString('pl-PL'); }catch{ return s||'-'; } }

    async function loadOrders(){
      const state=qs('#state'); const tbody=qs('#orders');
      state.textContent='Ładuję…';
      let data=null;
      const urls=['/api/orders?me=1','/api/me/orders','/api/orders'];
      for(const u of urls){ try{ const r=await api.get(u); data=r.data; if(data) break; }catch{} }
      const list = Array.isArray(data?.items) ? data.items : Array.isArray(data) ? data : [];
      if(!list.length){ state.textContent='Brak zamówień.'; return; }
      state.textContent='';
      tbody.innerHTML = list.map(o=>{
        const course = o.course || o.courseTitle || o.title || (o.catalogItem?.title) || 'Kurs';
        const slug   = o.slug   || o.courseSlug || (o.catalogItem?.slug) || localStorage.getItem('lastCourseSlug') || '';
        const date   = o.created_at || o.createdAt || o.date;
        const status = (o.status || o.order_status || 'paid').toString().toUpperCase();
        const action = slug ? `<a class="btn" href="./materials.html?slug=${encodeURIComponent(slug)}">Materiały</a>`
                            : `<a class="btn" href="./index.html#sklep">Do sklepu</a>`;
        return `<tr class="row reveal"><td>${course}</td><td>${fmtDate(date)}</td><td class="muted-small">${status}</td><td style="text-align:right">${action}</td></tr>`;
      }).join('');
      setStagger(document); qsa('.row',tbody).forEach(el=>io.observe(el));
    }

    /* logout (best-effort) */
    qs('#logout').addEventListener('click', async (e)=>{
      e.preventDefault();
      const urls=['/api/auth/logout','/api/logout'];
      for(const u of urls){ try{ await api.post(u,{}); break; }catch{} }
      toast('Wylogowano');
      setTimeout(()=>location.href='./index.html',600);
    });

    await loadMe();
    await loadOrders();
  </script>
</body>
</html>
