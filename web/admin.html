<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Panel administratora | Centrum Szkoleniowe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Prosty panel administracyjny do podglądu kursów i testowych zakupów (fake/PayU sandbox)." />
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="logo" href="./index.html" aria-label="Strona główna">
        <span class="logo-dot"></span> Centrum Szkoleniowe
      </a>
      <button class="hamburger" aria-label="Otwórz menu" aria-expanded="false" aria-controls="main-nav">
        <span></span><span></span><span></span>
      </button>
      <nav id="main-nav" class="nav">
        <a href="./index.html" class="nav-link">Sklep</a>
        <a href="./kurs.html?slug=instruktor-plywania" class="nav-link">Szczegóły kursu</a>
        <a href="./quiz.html" class="nav-link">Quiz (demo)</a>
        <a href="./admin.html" class="nav-link active">Admin</a>
      </nav>
    </div>
  </header>

  <main class="site-main container">
    <section class="hero" style="margin-bottom:16px">
      <div class="hero-badge">Tylko do testów</div>
      <h1>Panel administratora</h1>
      <p class="muted">Podgląd kursów z bazy i szybkie wyklikanie zamówienia <strong>(fake/PayU)</strong> bez przeładowań.</p>
      <div class="hero-cta">
        <a class="btn btn-ghost" href="/api/catalog" target="_blank" rel="noopener">Otwórz /api/catalog</a>
        <a class="btn btn-ghost" href="/health" target="_blank" rel="noopener">Otwórz /health</a>
      </div>
    </section>

    <section class="grid" style="grid-template-columns: 280px 1fr; align-items:start;">
      <!-- Lista kursów -->
      <aside class="card" style="position:sticky; top:84px;">
        <div class="body">
          <h3 class="title">Kursy</h3>
          <p class="desc">Kliknij kurs, aby wczytać szczegóły.</p>
          <div id="courses-state" class="state"></div>
          <div id="courses-list" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>
      </aside>

      <!-- Szczegóły / akcje -->
      <section class="card">
        <div class="body" id="details">
          <h3 class="title">Szczegóły kursu</h3>
          <p class="desc">Wybierz kurs z lewej strony, aby zobaczyć dane i wykonać testowy zakup.</p>

          <div id="course-box" style="display:none; gap:8px; margin-top:8px;">
            <div class="muted" id="course-slug"></div>
            <h2 id="course-title" style="margin:4px 0;"></h2>
            <p id="course-desc" class="muted"></p>
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
              <div class="price"><span id="course-price"></span></div>
              <a class="btn btn-ghost" id="open-public" href="#" target="_blank" rel="noopener">Zobacz publicznie</a>
            </div>

            <hr style="border:none; border-top:1px solid var(--border); margin:12px 0">

            <h4>Testowy zakup (guest)</h4>
            <form id="order-form" class="field" style="max-width:420px;">
              <label class="field">
                <span>E-mail kupującego</span>
                <input id="order-email" type="email" placeholder="test@example.com" required />
              </label>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn btn-primary" id="btn-create-order" type="submit">Utwórz zamówienie + płatność</button>
                <button class="btn btn-ghost" id="btn-fake-flow" type="button" title="Wymusza płatność FAKE po stronie backendu (jeśli PAYMENTS_PROVIDER=fake)">Szybki FAKE flow</button>
              </div>
            </form>

            <div id="order-result" class="quiz-result" style="margin-top:12px; display:none;">
              <div class="result-card" id="order-card">
                <h3 style="margin-top:0">Wynik operacji</h3>
                <div id="order-output" class="muted"></div>
              </div>
            </div>

            <div class="tiny muted" style="margin-top:8px">
              Po udanej płatności backend tworzy magic link i wysyła go e-mailem (jeśli masz skonfigurowany SMTP). <br>
              Brak SMTP? Odczytaj token: <code>SELECT token FROM magic_links ORDER BY created_at DESC LIMIT 1;</code>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <div>&copy; <span id="year"></span> Centrum Szkoleniowe</div>
      <div class="footer-links">
        <a href="#" aria-disabled="true">Polityka prywatności</a>
        <a href="#" aria-disabled="true">Regulamin</a>
        <a href="#" aria-disabled="true">Cookies</a>
      </div>
    </div>
  </footer>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module" src="./js/api.js"></script>
  <script type="module">
    import { api } from './js/api.js';
    import { qs, qsa, on, money, toast, setupHeader } from './js/app.js';

    setupHeader();
    document.getElementById('year').textContent = new Date().getFullYear();

    const stateEl = qs('#courses-state');
    const listEl = qs('#courses-list');
    const boxEl = qs('#course-box');
    const titleEl = qs('#course-title');
    const descEl = qs('#course-desc');
    const priceEl = qs('#course-price');
    const slugEl = qs('#course-slug');
    const openPublic = qs('#open-public');
    const orderForm = qs('#order-form');
    const orderEmail = qs('#order-email');
    const orderResult = qs('#order-result');
    const orderOutput = qs('#order-output');

    let current = null; // { slug, title, description, price, currency }

    async function loadCourses() {
      stateEl.textContent = 'Ładowanie kursów…';
      try {
        const { data } = await api.get('/api/catalog');
        if (!data.length) {
          stateEl.textContent = 'Brak kursów.';
          return;
        }
        listEl.innerHTML = data
          .map(c => `<button class="btn btn-ghost" data-slug="${c.slug}" style="justify-content:flex-start">${c.title}</button>`)
          .join('');
        stateEl.textContent = '';

        qsa('[data-slug]', listEl).forEach(btn => {
          btn.addEventListener('click', async () => selectCourse(btn.dataset.slug));
        });

        // auto-select pierwszego
        await selectCourse(data[0].slug);
      } catch (e) {
        console.error(e);
        stateEl.textContent = 'Błąd ładowania kursów.';
      }
    }

    async function selectCourse(slug) {
      try {
        stateEl.textContent = 'Ładowanie szczegółów…';
        const { data } = await api.get(`/api/catalog/${slug}`);
        current = data;
        renderCourse();
        stateEl.textContent = '';
      } catch (e) {
        console.error(e);
        toast('Nie udało się pobrać szczegółów kursu.');
      }
    }

    function renderCourse() {
      if (!current) return;
      boxEl.style.display = 'grid';
      slugEl.textContent = `Slug: ${current.slug}`;
      titleEl.textContent = current.title;
      descEl.textContent = current.description;
      priceEl.textContent = money(current.price, current.currency);
      openPublic.href = `./kurs.html?slug=${encodeURIComponent(current.slug)}`;
      orderEmail.value = 'test@example.com';
      orderResult.style.display = 'none';
      orderOutput.innerHTML = '';
    }

    // klasyczny flow: utwórz order → create payment (bez redirectu)
    async function createOrderAndPayment(email) {
      if (!current) return toast('Najpierw wybierz kurs.');
      try {
        const { data: order } = await api.post(`/api/catalog/${current.slug}/order`, { email });
        const { data: pay } = await api.post('/api/payments/create', { orderId: order.orderId });
        return { orderId: order.orderId, redirectUrl: pay.redirectUrl || null };
      } catch (e) {
        console.error(e);
        throw e;
      }
    }

    // submit formularza
    on('#order-form', 'submit', async (ev) => {
      ev.preventDefault();
      const email = orderEmail.value.trim();
      if (!email) return toast('Podaj e-mail.');

      try {
        const res = await createOrderAndPayment(email);
        orderResult.style.display = 'block';
        orderOutput.innerHTML = `
          <div>orderId: <code>${res.orderId}</code></div>
          ${res.redirectUrl ? `<div>redirectUrl: <a href="${res.redirectUrl}" target="_blank" rel="noopener">${res.redirectUrl}</a></div>` : `<div>redirectUrl: <em>brak (fake)</em></div>`}
          <div class="tiny muted" style="margin-top:8px">Jeśli płatność jest FAKE, backend od razu tworzy magic link i (opcjonalnie) wysyła e-mail.</div>
        `;
        toast('Zamówienie utworzone.');
      } catch {
        toast('Błąd tworzenia zamówienia lub płatności.');
      }
    });

    // szybki FAKE (wywołuje to samo co submit – różnica tylko semantyczna)
    on('#btn-fake-flow', 'click', async () => {
      const email = orderEmail.value.trim() || 'test@example.com';
      try {
        const res = await createOrderAndPayment(email);
        orderResult.style.display = 'block';
        orderOutput.innerHTML = `
          <div>orderId: <code>${res.orderId}</code></div>
          <div>redirectUrl: <em>${res.redirectUrl || 'FAKE – brak przekierowania'}</em></div>
        `;
        toast('FAKE flow OK.');
      } catch {
        toast('Błąd FAKE flow.');
      }
    });

    loadCourses();
  </script>
</body>
</html>
