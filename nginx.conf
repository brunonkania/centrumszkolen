# nginx.conf – produkcja
worker_processes auto;

events {
  worker_connections 1024;
}

http {
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;

  # Bezpieczne nagłówki
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header X-XSS-Protection "0" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), interest-cohort=()" always;
  # HSTS – włącz po potwierdzeniu HTTPS i subdomen
  # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

  # Kompresja
  gzip on;
  gzip_types text/plain text/css application/javascript application/json image/svg+xml;
  gzip_min_length 1024;

  # Serwer
  server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;

    # Serwuj statyki z cache
    location ~* \.(?:css|js|jpg|jpeg|png|gif|svg|ico|woff2?)$ {
      access_log off;
      expires 30d;
      add_header Cache-Control "public, max-age=2592000, immutable";
      try_files $uri =404;
    }

    # Sitemap i robots (podaj ścieżki jeżeli inne)
    location = /sitemap.xml {
      proxy_pass http://server:3000/sitemap.xml;
    }
    location = /robots.txt { try_files $uri =404; }

    # API proxy → Node
    location /api/ {
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://server:3000/api/;
    }

    # Routing dla /access/:token (serwuj materials.html)
    location ~ ^/access/[a-f0-9]{32}$ {
      try_files /materials.html =404;
    }

    # Reszta plików z /usr/share/nginx/html
    location / {
      try_files $uri $uri/ /index.html;
    }
  }
}
